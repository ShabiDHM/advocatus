# FILE: Caddyfile
# PHOENIX PROTOCOL DEFINITIVE VERSION 3.0 (WEBSOCKET SUPPORT FIXED):
# 1. CRITICAL FIX: Corrected WebSocket header syntax to use {http.request.header.*}
# 2. This is the definitive fix for WebSocket connection failures.

advocatus-prod-api.duckdns.org {
    # Automatic HTTPS via Let's Encrypt
    tls shabanbala@gmail.com

    # Standard security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }

    # Reverse proxy ALL traffic to the backend service with proper WebSocket support
    reverse_proxy backend:8000 {
        # Standard headers for backend application to understand the original request
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}

        # --- PHOENIX PROTOCOL FIX: CORRECT WebSocket header syntax ---
        header_up Connection {http.request.header.Connection}
        header_up Upgrade {http.request.header.Upgrade}
    }
}