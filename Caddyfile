# FILE: Caddyfile
# PHOENIX PROTOCOL PHASE XIV - FINAL MODIFICATION (Infrastructure Integrity)
# CORRECTION: Added an explicit header block to the WebSocket reverse_proxy.
# This forces Caddy to pass the critical 'Connection' and 'Upgrade' headers
# to the backend, ensuring the WebSocket handshake succeeds. This is the
# definitive fix for the persistent '1006 Abnormal Closure' error.

advocatus-prod-api.duckdns.org {
    # Automatic HTTPS via Let's Encrypt
    tls shabanbala@gmail.com

    # Standard security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }

    # The route block correctly enforces order of operations.
    route {
        # 1. WebSocket route - MUST come first.
        # This block now explicitly forwards the required WebSocket handshake headers.
        reverse_proxy /ws/* backend:8000 {
            header_up +Connection {http.request.header.Connection}
            header_up +Upgrade {http.request.header.Upgrade}
        }

        # 2. Standard API routes
        reverse_proxy /api/* backend:8000 {
            flush_interval -1
        }

        # 3. Health and root endpoints
        reverse_proxy /health backend:8000
        reverse_proxy / backend:8000
    }
}