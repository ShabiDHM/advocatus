# FILE: Caddyfile
# PHOENIX PROTOCOL - FINAL DEFINITIVE VERSION (PROTOCOL FORCING)
# CORRECTION: Explicitly forcing the reverse proxy for WebSockets to use HTTP/1.1.
# This is the definitive fix for a suspected low-level protocol negotiation failure
# that was causing the WebSocket handshake to be dropped before Caddy could log it.
# HTTP/3 is also disabled globally to reduce complexity.

{
    # Disabling HTTP/3 to simplify the protocol stack.
    servers {
        protocol {
            allow_h3 false
        }
    }
}

advocatus-prod-api.duckdns.org {
    tls shabanbala@gmail.com

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }

    route {
        reverse_proxy /ws/* backend:8000 {
            # This transport block is the critical fix.
            transport http {
                versions 1.1
            }
            header_up +Connection {http.request.header.Connection}
            header_up +Upgrade {http.request.header.Upgrade}
            header_up Sec-WebSocket-Protocol {http.request.header.Sec-WebSocket-Protocol}
        }
        
        reverse_proxy backend:8000
    }
}