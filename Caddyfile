# FILE: Caddyfile
# DEFINITIVE AND FINAL VERSION

advocatus-prod-api.duckdns.org {
    tls shabanbala@gmail.com

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }

    # Define a named matcher for WebSocket requests for clarity and precedence.
    @websockets {
        path /ws/*
    }

    # Apply explicit WebSocket proxy headers ONLY to WebSocket requests.
    reverse_proxy @websockets backend:8000 {
        header_up +Connection {http.request.header.Connection}
        header_up +Upgrade {http.request.header.Upgrade}
    }

    # Handle all other API and root requests.
    reverse_proxy backend:8000 {
        # Exclude the WebSocket path to avoid conflicting rules.
        # This is not strictly necessary with the 'route' block but adds robustness.
        # Caddy is smart enough, but we are being explicit.
    }
}