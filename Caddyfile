# FILE: Caddyfile

advocatus-prod-api.duckdns.org {
    # Automatic HTTPS via Let's Encrypt
    tls shabanbala@gmail.com

    # Standard security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
    }

    # --- PHOENIX PROTOCOL CURE: Architecturally Sound Routing with Stream Integrity ---
    route {
        # 1. First, match WebSocket requests and proxy them. This connection is persistent
        #    and does not require buffering changes.
        reverse_proxy /ws/* backend:8000

        # 2. Second, match all other API requests and proxy them WITHOUT BUFFERING.
        #    - `flush_interval -1` is the definitive cure. It disables Caddy's response
        #      buffering, which is critical for correctly proxying streaming responses
        #      (like PDF file downloads) from the FastAPI backend. This prevents stream
        #      corruption and ensures file integrity.
        reverse_proxy backend:8000 {
            flush_interval -1
        }
    }
}